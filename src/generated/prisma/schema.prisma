generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum RoleName {
  ADMIN
  TECHNICIAN
  USER
}

enum AccessLevel {
  NONE
  READ
  WRITE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Criticality {
  LOW
  MEDIUM
  HIGH
}

enum Condition {
  GOOD
  FAIR
  POOR
}

enum MainUse {
  RESIDENTIAL
  COMMERCIAL
  CULTURAL
  OFFICE
  RECREATIONAL
  WAREHOUSE
  EDUCATIONAL
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Category {
  APARTMENT
  HOUSE
  OFFICE
  SHOP
  GARAGE
  OTHER
}

enum SiteType {
  BUILDING
  COMPLEX
  FLOOR
  UNIT
  ROOM
}

enum RoomUse {
  OFFICE
  DEPOT
  CANTEEN
  CELLAR
  TOILET
  MEETING_ROOM
  TECHNICAL_ROOM
  LABORATORY
}

enum Availability {
  IN_USE
  VACANT
  UNDER_CONSTRUCTION
  RENT
}

enum CompanyType {
  CORPORATE_GROUP
  CUSTOMER
  SUPPLIER
}

enum EmployeeType {
  CUSTOMER_EMPLOYEE
  EXTERNAL_EMPLOYEE
  INTERNAL_EMPLOYEE
  SUPPLIER_EMPLOYEE
}

enum MaintenanceType {
  PREVENTIVE // Routine, Scheduled Inspections
  CORRECTIVE // Fix manually when it spoils aka REACTIVE
  PREDICTIVE // AI/ML to predict when maintenance is needed
}

enum Status {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum ProcessType {
  MAINTENANCE
  CORRECTIVE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

// ========================  MODELS =================================== //

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  firstName     String
  lastName      String
  status        UserStatus     @default(ACTIVE)
  roleId        String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  refreshTokens RefreshToken[]
  role          Role           @relation(fields: [roleId], references: [id])

  passwordResetToken String?
  passwordExpiresAt  DateTime?
  passwordResetAt    DateTime?
  employees          Employee[]

  @@index([email])
  @@index([roleId])
  @@map("users")
}

enum AssetCategoryType {
  DEVICES
  FINISHINGS
  ITEMS
  MACHINERIES
}

model Role {
  id          String       @id @default(uuid())
  name        RoleName     @unique
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  permissions Permission[]
  users       User[]

  @@index([name])
  @@map("roles")
}

model Permission {
  id          String      @id @default(uuid())
  roleId      String
  resource    String
  accessLevel AccessLevel @default(NONE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  role        Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, resource])
  @@index([roleId])
  @@map("permissions")
}

model Complex {
  id               String          @id @default(uuid())
  code             String          @unique
  name             String
  availability     Availability    @default(IN_USE)
  status           ServiceStatus   @default(ACTIVE)
  calenderEntityId String?
  calenderEntity   CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: Cascade)

  // Location
  address String?
  city    String?
  zipCode String?

  // Maintenance Date
  condition   Condition   @default(GOOD)
  criticality Criticality @default(LOW)

  // Dimensions Data
  totalBuildings    Int?
  totalFloors       Int?
  totalUnits        Int?
  totalRooms        Int?
  glazedArea        Float?
  cleanableArea     Float?
  coveredArea       Float?
  totalNetArea      Float?
  totalGrossArea    Float?
  totalHeatedVolume Float?
  totalVolume       Float?

  // Relations
  buildings Building[]
  photos    File[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  floors       Floor[]
  units        Unit[]
  rooms        Room[]
  maintenances Maintenance[]
  preventives  Preventive[]

  @@map("complexes")
}

model Building {
  id   String @id @default(uuid())
  name String
  code String

  mainUse      MainUse       @default(RESIDENTIAL)
  availability Availability  @default(IN_USE)
  status       ServiceStatus @default(ACTIVE)

  // Maintenance Data
  condition   Condition   @default(GOOD)
  criticality Criticality @default(LOW)

  // Dimensional Date
  totalFloors       Int?
  totalUnits        Int?
  totalRooms        Int?
  glazedArea        Float?
  cleanableArea     Float?
  coveredArea       Float?
  totalNetArea      Float?
  totalGrossArea    Float?
  totalHeatedVolume Float?
  totalVolume       Float?

  // Location
  address   Address @relation(fields: [addressId], references: [id])
  addressId String

  complexId String
  complex   Complex @relation(fields: [complexId], references: [id], onDelete: Cascade)

  calenderEntityId String?
  calenderEntity   CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: Cascade)

  photos File[]
  floors Floor[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  units       Unit[]
  rooms       Room[]
  preventives Preventive[]

  @@unique([complexId, code])
  @@map("buildings")
}

model Floor {
  id     String        @id @default(uuid())
  code   String
  name   String
  level  Int
  status ServiceStatus @default(ACTIVE)

  condition   Condition   @default(GOOD)
  criticality Criticality @default(LOW)

  // Location Data
  complexId  String
  complex    Complex  @relation(fields: [complexId], references: [id])
  buildingId String
  building   Building @relation(fields: [buildingId], references: [id])

  // Dimensions Data
  totalUnits        Int?
  totalRooms        Int?
  glazedArea        Float?
  cleanableArea     Float?
  coveredArea       Float?
  totalNetArea      Float?
  totalGrossArea    Float?
  totalHeatedVolume Float?
  totalVolume       Float?

  rooms Room[]
  units Unit[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  maintenances Maintenance[]
  preventives  Preventive[]

  @@unique([buildingId, code])
  @@map("floors")
}

model Unit {
  id           String        @id @default(uuid())
  code         String
  name         String
  availability Availability  @default(IN_USE)
  status       ServiceStatus @default(ACTIVE)

  calenderEntityId String?
  calenderEntity   CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: Cascade)

  // Address
  complexId  String?
  complex    Complex?  @relation(fields: [complexId], references: [id])
  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id])
  floorId    String
  floor      Floor     @relation(fields: [floorId], references: [id], onDelete: Cascade)

  address String?
  city    String?
  zipCode String?

  // Maintenance Data
  totalRooms        Int?
  glazedArea        Float?
  cleanableArea     Float?
  coveredArea       Float?
  totalNetArea      Float?
  totalGrossArea    Float?
  totalHeatedVolume Float?
  totalVolume       Float?

  // Cadastral Data
  cadastralArea           Float?
  urbanSection            String?
  sheet                   String?
  plot                    String?
  subordinate             String?
  class                   Int?
  size                    Float?
  propertyRightsAndDuties String?
  cadastralIncome         Decimal?
  censusArea              String?
  subArea                 String?

  rooms  Room[]
  photos File[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([floorId, code])
  @@map("units")
}

model Room {
  id     String        @id @default(uuid())
  name   String
  code   String
  use    RoomUse       @default(OFFICE)
  status ServiceStatus @default(ACTIVE)

  calenderEntityId String?
  calenderEntity   CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: Cascade)

  // Location Data
  complexId  String?
  complex    Complex?  @relation(fields: [complexId], references: [id])
  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id])
  floorId    String
  floor      Floor     @relation(fields: [floorId], references: [id], onDelete: Cascade)
  unitId     String?
  unit       Unit?     @relation(fields: [unitId], references: [id])

  // Maintenance Data
  condition   Condition   @default(GOOD)
  criticality Criticality @default(LOW)

  // Dimensions Data
  glazedArea     Float?
  cleanableArea  Float?
  coveredArea    Float?
  totalNetArea   Float?
  totalGrossArea Float?
  height         Int?
  heated         Boolean @default(false)
  totalVolume    Float?

  photos File[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  maintenances Maintenance[]
  preventives  Preventive[]

  @@unique([floorId, buildingId, code])
  @@map("rooms")
}

// Assets
// categories - devices, finishings, items, machineries
// subcategories - devices: burglar devices, electrical devices, climate control devices etc.
// asset - door, window, siren, etc.
model AssetCategory {
  id          String            @id @default(uuid())
  name        String            @unique
  type        AssetCategoryType @default(DEVICES)
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  assets      Asset[]

  @@index([type])
  @@index([name])
  @@map("asset_categories")
}

model Asset {
  id          String        @id @default(uuid())
  name        String
  description String?
  categoryId  String
  category    AssetCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  maintenances Maintenance[]
  preventives  Preventive[]

  @@index([name])
  @@map("assets")
}

model File {
  id  String @id @default(uuid())
  url String @unique

  rooms         Room[]
  units         Unit[]
  buildings     Building[]
  complexes     Complex[]
  maintenance   Maintenance? @relation(fields: [maintenanceId], references: [id])
  maintenanceId String?

  @@map("files")
}

model Company {
  id          String      @id @default(uuid())
  code        String      @unique
  type        CompanyType @default(CORPORATE_GROUP)
  name        String
  description String

  address   Address @relation(fields: [addressId], references: [id])
  addressId String

  phone            String?
  alternativePhone String?
  email            String?
  website          String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  employees    Employee[]
  maintenances Maintenance[]

  @@map("companies")
}

model Employee {
  id     String       @id @default(uuid())
  code   String       @unique
  type   EmployeeType @default(CUSTOMER_EMPLOYEE)
  userId String
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  companyId String
  company   Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  status    ServiceStatus @default(ACTIVE)

  calenderEntityId      String?
  calenderEntity        CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: Cascade)
  teams                 Team[]
  // correntives      correntive[]
  performedMaintenances Maintenance[]   @relation("MaintenancePerformer")
  requestedMaintenances Maintenance[]   @relation("MaintenanceRequester")
  assignedMaintenances  Maintenance[]   @relation("MaintenanceAssignee")

  @@map("employees")
}

model Team {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?

  status ServiceStatus @default(ACTIVE)

  supervisorId String
  supervisor   Employee @relation(fields: [supervisorId], references: [id], onDelete: Cascade)

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  maintenances Maintenance[]
  preventives  Preventive[]

  @@map("teams")
}

model Address {
  id        String     @id @default(uuid())
  street    String
  city      String
  state     String
  zipCode   String
  companies Company[]
  buildings Building[]

  @@map("addresses")
}

model Contract {
  id          String @id @default(uuid())
  code        String @unique
  description String
}

model CalenderEntity {
  id   String @id @default(uuid())
  name String

  buildings Building[]
  complexes Complex[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  units     Unit[]
  rooms     Room[]
  employees Employee[]

  @@map("calender_entities")
}

model Maintenance {
  id               String          @id @default(uuid())
  type             MaintenanceType @default(PREVENTIVE)
  code             String          @unique
  description      String
  startDate        DateTime?
  endDate          DateTime?
  shortDescription String?
  action           String? // Lookup
  message          String?
  processNotes     String?

  performerId String? // Team or employee
  performer   Employee? @relation("MaintenancePerformer", fields: [performerId], references: [id], onDelete: Cascade)
  // parentProcessId String?

  processStatus     Status      @default(PENDING)
  register          String?
  activityIdTimer   String?
  activityStartTime DateTime?
  activityEndTime   DateTime?
  allDeadlines      String?
  processType       ProcessType @default(CORRECTIVE)
  ttSysRunning      Decimal?
  ttWorkRunning     Decimal?
  sorting           String?

  requesterId String?
  requester   Employee? @relation("MaintenanceRequester", fields: [requesterId], references: [id], onDelete: Cascade)

  priority Priority @default(LOW)

  siteId String
  site   Complex @relation(fields: [siteId], references: [id], onDelete: Cascade)

  outcome        String? // Lookup
  dueAssignedEnd DateTime? // Execution end date
  execStart      DateTime? // Execution start date
  dueExecEndDate DateTime? // Due execution end date
  execEndDate    DateTime? // Execution end date
  dueClosuerDate DateTime? // Due closure date
  totalExecTime  Decimal? // Total execution time

  expStartDate DateTime?

  suspensionReason String? // Lookup

  category    String? // Reference
  subCategory String? // Reference

  companyId String? // Reference
  company   Company? @relation(fields: [companyId], references: [id])

  teamId  String?
  team    Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  floorId String?
  floor   Floor?  @relation(fields: [floorId], references: [id], onDelete: Cascade)
  roomId  String?
  room    Room?   @relation(fields: [roomId], references: [id], onDelete: Cascade)

  ttSystemOpening    Decimal?
  ttWorkOpening      Decimal?
  ttSystemAssignment Decimal?
  ttWorkAssignment   Decimal?
  ttSystemExecution  Decimal?
  ttWorkExecution    Decimal?
  ttSysSuspension    Decimal?
  ttWorkSuspension   Decimal?
  ttEstimate         Decimal?

  // For preventive
  prevMaintenanceConfigId String? // For Preventive
  automaticConfig         Boolean @default(true)
  jointAccounting         Boolean @default(false)
  hasTasks                Boolean @default(false)

  estimateStatus Status @default(PENDING)

  delayNotification Boolean   @default(false)
  assigneeId        String?
  assignee          Employee? @relation("MaintenanceAssignee", fields: [assigneeId], references: [id], onDelete: Cascade)

  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id])

  photos File[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  CUSTOM
}

model Preventive {
  id             String    @id @default(uuid())
  code           String    @unique
  name           String
  description    String
  frequency      Frequency @default(MONTHLY)
  cronExpression String? // For CUSTOM frequency

  // Scheduling
  lastRun DateTime?
  nextRun DateTime

  // Template Data for created Maintenance tasks
  priority Priority @default(MEDIUM)
  duration Int? // Estimated duration in minutes

  // Relations (Template targets)
  siteId String
  site   Complex @relation(fields: [siteId], references: [id], onDelete: Cascade)

  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id])

  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id])

  floorId String?
  floor   Floor?  @relation(fields: [floorId], references: [id])

  roomId String?
  room   Room?   @relation(fields: [roomId], references: [id])

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("preventives")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}
