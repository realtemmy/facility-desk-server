generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// enum RoleName {
//   ADMIN
//   TECHNICIAN
//   USER
// }

enum AccessLevel {
  NONE
  READ
  WRITE
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Criticality {
  LOW
  MEDIUM
  HIGH
}

enum Condition {
  GOOD
  FAIR
  POOR
}

enum MainUse {
  RESIDENTIAL
  COMMERCIAL
  CULTURAL
  OFFICE
  RECREATIONAL
  WAREHOUSE
  EDUCATIONAL
}

enum ServiceStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum Category {
  APARTMENT
  HOUSE
  OFFICE
  SHOP
  GARAGE
  OTHER
}

enum SiteType {
  BUILDING
  COMPLEX
  FLOOR
  UNIT
  ROOM
}

enum RoomUse {
  OFFICE
  DEPOT
  CANTEEN
  CELLAR
  TOILET
  MEETING_ROOM
  TECHNICAL_ROOM
  LABORATORY
  STORAGE
}

enum Availability {
  IN_USE
  VACANT
  UNDER_CONSTRUCTION
  RENT
}

enum CompanyType {
  CORPORATE_GROUP
  CUSTOMER
  SUPPLIER
}

enum EmployeeType {
  CUSTOMER_EMPLOYEE
  EXTERNAL_EMPLOYEE
  INTERNAL_EMPLOYEE
  SUPPLIER_EMPLOYEE
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  CUSTOM
}

enum MaintenanceType {
  PREVENTIVE // Routine, Scheduled Inspections
  CORRECTIVE // Breakdown repairs
  PREDICTIVE // Condition monitoring
  EMERGENCY // Life safety, rapid response
  INSPECTION // Periodic compliance checks
  CALIBRATION // Instrument recalibration
  SMALL_PROJECT // Renovations, MAC
  SOFT_SERVICE // Cleaning, landscaping, etc.
}

enum Status {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum ProcessType {
  MAINTENANCE
  CORRECTIVE
}

enum AssetCategoryType {
  DEVICES
  FINISHINGS
  ITEMS
  MACHINERIES
}

enum Priority {
  LOW
  MEDIUM
  HIGH
}

enum StockMovementType {
  LOAD
  UNLOAD
  TRANSFER
}

enum StockReferenceType {
  MAINTENANCE
  PURCHASE_ORDER
  MANUAL
  OTHER
}

enum State {
  Fct
  Abia
  Adamawa
  AkwaIbom
  Anambra
  Bauchi
  Bayelsa
  Benue
  Borno
  CrossRiver
  Delta
  Ebonyi
  Edo
  Ekiti
  Enugu
  Gombe
  Imo
  Jigawa
  Kaduna
  Kano
  Katsina
  Kebbi
  Kogi
  Kwara
  Lagos
  Nasarawa
  Niger
  Ogun
  Ondo
  Osun
  Oyo
  Plateau
  Rivers
  Sokoto
  Taraba
  Yobe
  Zamfara
}

// =======================================================================
// ============================ MODELS =================================== 
// =======================================================================

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  firstName     String
  lastName      String
  roleId        String
  status        UserStatus     @default(ACTIVE)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  refreshTokens RefreshToken[]
  role          Role           @relation(fields: [roleId], references: [id])
  permissions   Permission[] // Direct permissions

  passwordResetToken String?
  passwordExpiresAt  DateTime?
  passwordResetAt    DateTime?

  // Employee Fields
  employeeCode  String?       @unique
  employeeType  EmployeeType? @default(CUSTOMER_EMPLOYEE)
  companyId     String?
  company       Company?      @relation(fields: [companyId], references: [id])
  serviceStatus ServiceStatus @default(ACTIVE)

  calenderEntityId String?
  calenderEntity   CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: SetNull)

  // Relations
  teams                 Team[]
  performedMaintenances Maintenance[] @relation("MaintenancePerformer")
  requestedMaintenances Maintenance[] @relation("MaintenanceRequester")
  assignedMaintenances  Maintenance[] @relation("MaintenanceAssignee")
  supervisedTeams       Team[]        @relation("TeamSupervisor")

  @@index([email])
  @@index([roleId])
  @@map("users")
}

model Role {
  id          String       @id @default(uuid())
  name        String       @unique
  isSystem    Boolean      @default(false)
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  permissions Permission[]
  users       User[]

  @@index([name])
  @@map("roles")
}

model Permission {
  id          String      @id @default(uuid())
  roleId      String
  resource    String
  accessLevel AccessLevel @default(NONE)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  role        Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user        User?       @relation(fields: [userId], references: [id])
  userId      String?

  @@unique([roleId, resource, accessLevel])
  @@index([roleId])
  @@map("permissions")
}

model Site {
  id          String  @id @default(uuid())
  name        String
  address     Address @relation(fields: [addressId], references: [id], onDelete: Cascade)
  climateZone String?
  description String?

  complexes Complex[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  addressId String   @unique

  @@map("sites")
}

model Complex {
  id               String          @id @default(uuid())
  code             String          @unique
  name             String
  availability     Availability    @default(IN_USE)
  status           ServiceStatus   @default(ACTIVE)
  calenderEntityId String?
  calenderEntity   CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: Cascade)

  // Location
  secondaryAddress String? // eg Second get entrance

  // Maintenance Date
  condition   Condition   @default(GOOD)
  criticality Criticality @default(LOW)

  // Dimensions Data
  totalBuildings    Int?
  totalFloors       Int?
  totalUnits        Int?
  totalRooms        Int?
  glazedArea        Float?
  cleanableArea     Float?
  coveredArea       Float?
  totalNetArea      Float?
  totalGrossArea    Float?
  totalHeatedVolume Float?
  totalVolume       Float?

  // Relations
  buildings Building[]
  photos    File[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  maintenances Maintenance[]
  preventives  Preventive[]

  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([name, siteId])
  @@map("complexes")
}

model Building {
  id   String @id @default(uuid())
  name String
  code String @unique

  mainUse      MainUse       @default(RESIDENTIAL)
  availability Availability  @default(IN_USE)
  status       ServiceStatus @default(ACTIVE)

  // Maintenance Data
  condition   Condition   @default(GOOD)
  criticality Criticality @default(LOW)

  // Dimensional Date
  totalFloors       Int?
  totalUnits        Int?
  totalRooms        Int?
  glazedArea        Float?
  cleanableArea     Float?
  coveredArea       Float?
  totalNetArea      Float?
  totalGrossArea    Float?
  totalHeatedVolume Float?
  totalVolume       Float?

  // Location
  subAddress String? // eg Building B, 100 Main St

  complexId String
  complex   Complex @relation(fields: [complexId], references: [id], onDelete: Cascade)

  calenderEntityId String?
  calenderEntity   CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: Cascade)

  photos File[]
  floors Floor[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  preventives  Preventive[]
  maintenances Maintenance[]

  @@unique([complexId, name])
  @@map("buildings")
}

model Floor {
  id     String        @id @default(uuid())
  code   String        @unique
  name   String
  level  Int
  type   String? // "office", "retail", "technical"
  status ServiceStatus @default(ACTIVE)

  condition   Condition   @default(GOOD)
  criticality Criticality @default(LOW)

  // Location Data
  buildingId String
  building   Building @relation(fields: [buildingId], references: [id])

  // Dimensions Data
  totalUnits        Int?
  totalRooms        Int?
  glazedArea        Float?
  cleanableArea     Float?
  coveredArea       Float?
  totalNetArea      Float?
  totalGrossArea    Float?
  totalHeatedVolume Float?
  totalVolume       Float?

  zones Zone[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  maintenances Maintenance[]
  preventives  Preventive[]

  @@unique([buildingId, name])
  @@map("floors")
}

model Zone {
  id           String        @id @default(uuid())
  code         String        @unique
  name         String
  type         String? // "fire compartment", "wing", "tenant demarcation"
  availability Availability  @default(IN_USE)
  status       ServiceStatus @default(ACTIVE)

  calenderEntityId String?
  calenderEntity   CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: Cascade)

  // Address
  floorId String
  floor   Floor  @relation(fields: [floorId], references: [id], onDelete: Cascade)

  // Maintenance Data
  totalRooms        Int?
  glazedArea        Float?
  cleanableArea     Float?
  coveredArea       Float?
  totalNetArea      Float?
  totalGrossArea    Float?
  totalHeatedVolume Float?
  totalVolume       Float?

  // Cadastral Data
  cadastralArea           Float?
  urbanSection            String?
  sheet                   String?
  plot                    String?
  subordinate             String?
  class                   Int?
  size                    Float?
  propertyRightsAndDuties String?
  cadastralIncome         Decimal?
  censusArea              String?
  subArea                 String?

  rooms  Space[]
  photos File[]
  items  MaintenanceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([floorId, name])
  @@map("zones")
}

model Space {
  id     String        @id @default(uuid())
  name   String
  code   String        @unique
  use    RoomUse       @default(OFFICE)
  status ServiceStatus @default(ACTIVE)

  calenderEntityId String?
  calenderEntity   CalenderEntity? @relation(fields: [calenderEntityId], references: [id], onDelete: Cascade)

  // Location Data

  zoneId String
  zone   Zone   @relation(fields: [zoneId], references: [id])

  // Maintenance Data
  condition   Condition   @default(GOOD)
  criticality Criticality @default(LOW)

  // Dimensions Data
  glazedArea     Float?
  cleanableArea  Float?
  coveredArea    Float?
  totalNetArea   Float?
  totalGrossArea Float?
  height         Int?
  heated         Boolean @default(false)
  totalVolume    Float?

  photos File[]

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  maintenances Maintenance[]
  preventives  Preventive[]

  assets Asset[]

  @@unique([zoneId, name])
  @@map("spaces")
}

// Assets
// categories - devices, finishings, items, machineries
// subcategories - devices: burglar devices, electrical devices, climate control devices etc.
// asset - door, window, siren, etc.

model AssetType {
  id   String @id @default(uuid())
  name String @unique
}

model AssetCategory {
  id          String            @id @default(uuid())
  name        String            @unique
  type        AssetCategoryType @default(DEVICES)
  description String?
  assets      Asset[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([name])
  @@map("asset_categories")
}

model Asset {
  id          String        @id @default(uuid())
  name        String
  description String?
  categoryId  String
  category    AssetCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  tag            String? @unique
  parentSystemId String?
  parentSystem   Asset?  @relation("AssetHierarchy", fields: [parentSystemId], references: [id])
  childAssets    Asset[] @relation("AssetHierarchy")

  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id])

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  maintenances Maintenance[]
  preventives  Preventive[]

  @@index([name])
  @@map("assets")
}

model File {
  id  String @id @default(uuid())
  url String @unique

  spaces        Space[]
  zones         Zone[]
  buildings     Building[]
  complexes     Complex[]
  maintenance   Maintenance? @relation(fields: [maintenanceId], references: [id])
  maintenanceId String?

  @@map("files")
}

model Company {
  id          String      @id @default(uuid())
  code        String      @unique
  type        CompanyType @default(CORPORATE_GROUP)
  name        String
  description String

  address   Address @relation(fields: [addressId], references: [id], onDelete: Cascade)
  addressId String

  phone            String?
  alternativePhone String?
  email            String?
  website          String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  employees    User[]
  maintenances Maintenance[]

  @@map("companies")
}

model Team {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?

  status ServiceStatus @default(ACTIVE)

  supervisorId String
  supervisor   User   @relation("TeamSupervisor", fields: [supervisorId], references: [id], onDelete: Cascade)

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  maintenances Maintenance[]
  preventives  Preventive[]
  members      User[]

  @@map("teams")
}

model Address {
  id        String  @id @default(uuid())
  street    String
  city      String
  state     State   @default(Lagos)
  zipCode   String?
  latitude  Float?
  longitude Float?

  companies  Company[]
  sites      Site[]
  warehouses Warehouse[]

  @@unique([street, city, state, zipCode])
  @@map("addresses")
}

model Contract {
  id          String @id @default(uuid())
  code        String @unique
  description String
}

model CalenderEntity {
  id   String @id @default(uuid())
  name String

  buildings Building[]
  complexes Complex[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  spaces    Space[]
  zones     Zone[]
  employees User[]

  @@map("calender_entities")
}

model Maintenance {
  id               String          @id @default(uuid())
  type             MaintenanceType @default(PREVENTIVE)
  code             String          @unique
  description      String
  startDate        DateTime?
  endDate          DateTime?
  shortDescription String?
  action           String? // Lookup
  message          String?
  processNotes     String?
  metadata         Json? // Use Zod schema to validate based on type

  performerId String?
  performer   User?   @relation("MaintenancePerformer", fields: [performerId], references: [id], onDelete: Cascade)

  processStatus     Status      @default(PENDING)
  register          String?
  activityIdTimer   String?
  activityStartTime DateTime?
  activityEndTime   DateTime?
  allDeadlines      String?
  processType       ProcessType @default(CORRECTIVE)
  ttSysRunning      Decimal?
  ttWorkRunning     Decimal?
  sorting           String?

  requesterId String?
  requester   User?   @relation("MaintenanceRequester", fields: [requesterId], references: [id], onDelete: Cascade)

  priority Priority @default(LOW)

  siteId String
  site   Complex @relation(fields: [siteId], references: [id], onDelete: Cascade)

  outcome        String? // Lookup
  dueAssignedEnd DateTime? // Execution end date
  execStart      DateTime? // Execution start date
  dueExecEndDate DateTime? // Due execution end date
  execEndDate    DateTime? // Execution end date
  dueClosuerDate DateTime? // Due closure date
  totalExecTime  Decimal? // Total execution time

  expStartDate DateTime?

  suspensionReason String? // Lookup

  category    String? // Reference
  subCategory String? // Reference

  companyId String? // Reference
  company   Company? @relation(fields: [companyId], references: [id])

  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id])

  teamId  String?
  team    Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  floorId String?
  floor   Floor?  @relation(fields: [floorId], references: [id], onDelete: Cascade)
  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  ttSystemOpening    Decimal?
  ttWorkOpening      Decimal?
  ttSystemAssignment Decimal?
  ttWorkAssignment   Decimal?
  ttSystemExecution  Decimal?
  ttWorkExecution    Decimal?
  ttSysSuspension    Decimal?
  ttWorkSuspension   Decimal?
  ttEstimate         Decimal?

  // For preventive
  prevMaintenanceConfigId String? // For Preventive
  automaticConfig         Boolean @default(true)
  jointAccounting         Boolean @default(false)
  hasTasks                Boolean @default(false)

  estimateStatus Status @default(PENDING)

  delayNotification Boolean @default(false)
  assigneeId        String?
  assignee          User?   @relation("MaintenanceAssignee", fields: [assigneeId], references: [id], onDelete: Cascade)

  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id])

  photos File[]

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  maintenanceItems MaintenanceItem[]

  @@map("maintenances")
}

model Preventive {
  id             String    @id @default(uuid())
  code           String    @unique
  name           String
  description    String
  frequency      Frequency @default(MONTHLY)
  cronExpression String? // For CUSTOM frequency

  // Scheduling
  lastRun DateTime?
  nextRun DateTime

  // Template Data for created Maintenance tasks
  priority Priority @default(MEDIUM)
  duration Int? // Estimated duration in minutes

  // Relations (Template targets)
  siteId String
  site   Complex @relation(fields: [siteId], references: [id], onDelete: Cascade)

  assetId String?
  asset   Asset?  @relation(fields: [assetId], references: [id])

  buildingId String?
  building   Building? @relation(fields: [buildingId], references: [id])

  floorId String?
  floor   Floor?  @relation(fields: [floorId], references: [id])

  spaceId String?
  space   Space?  @relation(fields: [spaceId], references: [id])

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("preventives")
}

model Warehouse {
  id          String  @id @default(uuid())
  // status         WarehouseStatus         Abandoned, Active, Inactive
  name        String
  description String?

  address   Address @relation(fields: [addressId], references: [id], onDelete: Cascade)
  addressId String

  stocks                 Stock[]
  stockMovements         StockMovement[] @relation("WarehouseStockMovements")
  incomingStockMovements StockMovement[] @relation("TargetWarehouseStockMovements")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("warehouses")
}

model Item {
  id            String  @id @default(uuid())
  name          String  @unique
  description   String?
  code          String  @unique
  category      String?
  unitOfMeasure String?

  stocks           Stock[]
  stockMovements   StockMovement[]
  maintenanceItems MaintenanceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("items")
}

model Stock {
  id          String @id @default(uuid())
  quantity    Int    @default(0)
  minQuantity Int    @default(0) // For alerts
  maxQuantity Int? // Optional max capacity

  itemId String
  item   Item   @relation(fields: [itemId], references: [id])

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([itemId, warehouseId])
  @@map("stocks")
}

model StockMovement {
  id       String            @id @default(uuid())
  type     StockMovementType @default(LOAD) // transfering stsocks should be done using prisma transactions
  quantity Int               @default(0)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id])

  warehouseId String
  warehouse   Warehouse @relation("WarehouseStockMovements", fields: [warehouseId], references: [id])

  targetWarehouseId String?
  targetWarehouse   Warehouse? @relation("TargetWarehouseStockMovements", fields: [targetWarehouseId], references: [id])

  // Context & Traceability
  referenceId   String?
  referenceType StockReferenceType?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("stock_movements")
}

model MaintenanceItem {
  id       String   @id @default(uuid())
  quantity Int
  cost     Decimal? @default(0)

  maintenanceId String
  maintenance   Maintenance @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  zone      Zone?    @relation(fields: [zoneId], references: [id])
  zoneId    String?

  @@unique([maintenanceId, itemId])
  @@map("maintenance_items")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("refresh_tokens")
}
